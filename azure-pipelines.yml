# Node.js with Angular
# Build a Node.js project that uses Angular.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: env
  jobs:
    - job: Nodes
      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '12.13.1'
        displayName: 'Install Node.js'

- stage: build
  jobs:
    - job: build_site
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: |
            npm run build
            npm install -g surge
            bash ./scripts/surge.sh
  dependsOn: env

- stage: test
  jobs:
    - job: test_components
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: |
            npm run test
            cat ./coverage/lcov.info | ./node_modules/.bin/codecov

    - job: test_schematics
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: npm run test:schematics
  dependsOn: env

- stage: lint
  jobs:
    - job: lint_components
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: npm run lint
  dependsOn: env

- stage: integration
  jobs:
    - job: integration_cli
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: npm run integration-cli
    - job: integration_webpack
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: npm run integration-webpack
    - job: integration_rollup
      steps:
        - task: Npm@1
          inputs:
            command: 'install'
        - script: npm run integration-rollup
  dependsOn: env
